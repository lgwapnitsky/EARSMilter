

<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>EARS Milter main class/functions &mdash; EARSmilter 1.0 documentation</title>
    
    <link rel="stylesheet" href="../_static/default.css" type="text/css" />
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../',
        VERSION:     '1.0',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../_static/jquery.js"></script>
    <script type="text/javascript" src="../_static/underscore.js"></script>
    <script type="text/javascript" src="../_static/doctools.js"></script>
    <link rel="author" title="About these documents" href="../about.html" />
    <link rel="top" title="EARSmilter 1.0 documentation" href="../index.html" />
    <link rel="up" title="EARS Code" href="../codedocs.html" />
    <link rel="next" title="purgeEARSdb.py" href="purgeEARSdb_py.html" />
    <link rel="prev" title="EARS.py" href="EARS_py.html" /> 
  </head>
  <body>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="right" >
          <a href="purgeEARSdb_py.html" title="purgeEARSdb.py"
             accesskey="N">next</a> |</li>
        <li class="right" >
          <a href="EARS_py.html" title="EARS.py"
             accesskey="P">previous</a> |</li>
        <li><a href="../index.html">EARSmilter 1.0 documentation</a> &raquo;</li>
          <li><a href="../codedocs.html" accesskey="U">EARS Code</a> &raquo;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body">
            
  <div class="section" id="module-EARSmilter">
<span id="ears-milter-main-class-functions"></span><h1>EARS Milter main class/functions<a class="headerlink" href="#module-EARSmilter" title="Permalink to this headline">¶</a></h1>
<p>EARS milter class definition and mail processing functions</p>
<ul class="simple">
<li><a class="reference internal" href="#earslog"><em>EARSlog</em></a></li>
<li><a class="reference internal" href="#milter"><em>milter</em></a></li>
<li><a class="reference internal" href="#processmessage"><em>ProcessMessage</em></a></li>
<li><a class="reference internal" href="#filesys"><em>FileSys</em></a></li>
</ul>
<div class="section" id="earslog">
<span id="id1"></span><h2>EARSlog<a class="headerlink" href="#earslog" title="Permalink to this headline">¶</a></h2>
<dl class="class">
<dt id="EARSmilter.EARSmilter.EARSlog">
<em class="property">class </em><tt class="descclassname">EARSmilter.EARSmilter.</tt><tt class="descname">EARSlog</tt><a class="reference internal" href="../_modules/EARSmilter/EARSmilter.html#EARSlog"><span class="viewcode-link">[source]</span></a><a class="headerlink" href="#EARSmilter.EARSmilter.EARSlog" title="Permalink to this definition">¶</a></dt>
<dd><p>Establishes logging for different error statuses:  INFO, WARN, DEBUG, ERR</p>
</dd></dl>

</div>
<div class="section" id="milter">
<span id="id2"></span><h2>milter<a class="headerlink" href="#milter" title="Permalink to this headline">¶</a></h2>
<dl class="class">
<dt id="EARSmilter.EARSmilter.milter">
<em class="property">class </em><tt class="descclassname">EARSmilter.EARSmilter.</tt><tt class="descname">milter</tt><big>(</big><em>Milter.Base</em><big>)</big><a class="reference internal" href="../_modules/EARSmilter/EARSmilter.html#milter"><span class="viewcode-link">[source]</span></a><a class="headerlink" href="#EARSmilter.EARSmilter.milter" title="Permalink to this definition">¶</a></dt>
<dd><p>Milter processing derived from pymilter.</p>
<p><strong>Only functions that have been heavily modified from standard Milter processing
have been documented</strong></p>
<dl class="function">
<dt>
<tt class="descname">&#64;Milter.noreply</tt></dt>
<dt id="EARSmilter.milter.connect">
<tt class="descname">connect</tt><big>(</big><em>IPname</em>, <em>family</em>, <em>hostaddr</em><big>)</big><a class="headerlink" href="#EARSmilter.milter.connect" title="Permalink to this definition">¶</a></dt>
<dd><p>Initializes when a new connection to the Milter is made via SMTP</p>
</dd></dl>

<dl class="function">
<dt>
<tt class="descname">&#64;Milter.noreply</tt></dt>
<dt id="EARSmilter.milter.header">
<tt class="descname">header</tt><big>(</big><em>name</em>, <em>hval</em><big>)</big><a class="headerlink" href="#EARSmilter.milter.header" title="Permalink to this definition">¶</a></dt>
<dd><p>Processes headers from the incoming message and writes them to a variable for database storage</p>
<div class="highlight-py"><div class="highlight"><pre><span class="n">rgxSubject</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span> <span class="s">&#39;^(subject)&#39;</span><span class="p">,</span> <span class="n">re</span><span class="o">.</span><span class="n">IGNORECASE</span> <span class="o">|</span> <span class="n">re</span><span class="o">.</span><span class="n">DOTALL</span> <span class="p">)</span>
<span class="n">rgxMessageID</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span> <span class="s">&#39;^(message-id)&#39;</span><span class="p">,</span> <span class="n">re</span><span class="o">.</span><span class="n">IGNORECASE</span> <span class="o">|</span> <span class="n">re</span><span class="o">.</span><span class="n">DOTALL</span> <span class="p">)</span>
</pre></div>
</div>
<p>Regular Expression searches used to extract and log the Subject and Message ID of incoming messages</p>
</dd></dl>

<dl class="method">
<dt id="EARSmilter.EARSmilter.milter.eom">
<tt class="descname">eom</tt><big>(</big><big>)</big><a class="reference internal" href="../_modules/EARSmilter/EARSmilter.html#milter.eom"><span class="viewcode-link">[source]</span></a><a class="headerlink" href="#EARSmilter.EARSmilter.milter.eom" title="Permalink to this definition">¶</a></dt>
<dd><p>End-Of-Message milter function</p>
<p>Connection to the database is established here via the toDB class:</p>
<div class="highlight-py"><div class="highlight"><pre><span class="n">db</span> <span class="o">=</span> <span class="n">toDB</span><span class="p">(</span> <span class="s">&#39;root&#39;</span><span class="p">,</span> <span class="s">&#39;python&#39;</span><span class="p">,</span> <span class="s">&#39;python.dev.wrtdesign.com&#39;</span><span class="p">,</span> <span class="s">&#39;EARS&#39;</span> <span class="p">)</span>
</pre></div>
</div>
<p>The variables above can be changed accordingly.</p>
<p>New messages are initialized in the database via:</p>
<div class="highlight-py"><div class="highlight"><pre><span class="n">db</span><span class="o">.</span><span class="n">newMessage</span><span class="p">(</span> <span class="bp">self</span><span class="o">.</span><span class="n">canon_from</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">Subject</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">headers</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_msg</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">R</span> <span class="p">)</span>        
</pre></div>
</div>
<p>and are subsequently shipped to the ProcessMessage class to parse/remove attachments,
then add the EARS link page to the message before being sent to the recipient(s)</p>
<p>If an error occurs, an Exception is thrown and logged to the &lt;logname&gt;.err file</p>
</dd></dl>

</dd></dl>

</div>
<div class="section" id="processmessage">
<span id="id3"></span><h2>ProcessMessage<a class="headerlink" href="#processmessage" title="Permalink to this headline">¶</a></h2>
<dl class="class">
<dt id="EARSmilter.EARSmilter.ProcessMessage">
<em class="property">class </em><tt class="descclassname">EARSmilter.EARSmilter.</tt><tt class="descname">ProcessMessage</tt><big>(</big><em>_db</em>, <em>_log</em>, <em>_from</em><big>)</big><a class="reference internal" href="../_modules/EARSmilter/EARSmilter.html#ProcessMessage"><span class="viewcode-link">[source]</span></a><a class="headerlink" href="#EARSmilter.EARSmilter.ProcessMessage" title="Permalink to this definition">¶</a></dt>
<dd><p>All message processing is done via this class.</p>
<ul class="simple">
<li>Attachments are parsed/removed</li>
<li>Winmail.DAT files are extracted</li>
<li>Retreive_Attachments.html file is added to original message</li>
<li>Message information is stored in the MySQL database</li>
</ul>
<dl class="method">
<dt id="EARSmilter.EARSmilter.ProcessMessage.__init__">
<tt class="descname">__init__</tt><big>(</big><em>_db</em>, <em>_log</em>, <em>_from</em><big>)</big><a class="reference internal" href="../_modules/EARSmilter/EARSmilter.html#ProcessMessage.__init__"><span class="viewcode-link">[source]</span></a><a class="headerlink" href="#EARSmilter.EARSmilter.ProcessMessage.__init__" title="Permalink to this definition">¶</a></dt>
<dd><ul class="simple">
<li><strong>_db</strong> - toDB class</li>
<li><strong>_log</strong> - EARSlog class</li>
<li><strong>_from</strong> - sender&#8217;s e-mail address</li>
</ul>
<p><strong>subChange</strong> is set to <em>False</em>.  If no attachments are removed, <strong>subChange</strong>
will be set to <em>True</em> and &#8220;Removed Attachments&#8221; will be removed from the subject line</p>
</dd></dl>

<dl class="method">
<dt id="EARSmilter.EARSmilter.ProcessMessage.ParseAttachments">
<tt class="descname">ParseAttachments</tt><big>(</big><big>)</big><a class="reference internal" href="../_modules/EARSmilter/EARSmilter.html#ProcessMessage.ParseAttachments"><span class="viewcode-link">[source]</span></a><a class="headerlink" href="#EARSmilter.EARSmilter.ProcessMessage.ParseAttachments" title="Permalink to this definition">¶</a></dt>
<dd><p>The message is passed through this function in order to analyze and potentially remove attachments</p>
<p>If the attached file is WINMAIL.DAT, it is sent for further processing so that the files it contains
can be extracted and provided to the recipient(s)</p>
<p>Attachments are then analyzed for size and, if are above the set threshold, are detached.</p>
<p>If no attachments are extracted, the folder created in the <strong>dropDir</strong> is removed.</p>
<p>Otherwise, the &#8220;Retrieve_Attachments.html&#8221; notice is created and appended to the original message along
with any attachments that remained below the threshold</p>
</dd></dl>

<dl class="method">
<dt id="EARSmilter.EARSmilter.ProcessMessage.extract_attachment">
<tt class="descname">extract_attachment</tt><big>(</big><em>data</em>, <em>fname</em><big>)</big><a class="reference internal" href="../_modules/EARSmilter/EARSmilter.html#ProcessMessage.extract_attachment"><span class="viewcode-link">[source]</span></a><a class="headerlink" href="#EARSmilter.EARSmilter.ProcessMessage.extract_attachment" title="Permalink to this definition">¶</a></dt>
<dd><p>Used to extract attachments that are NOT in a WINMAIL.DAT file.</p>
<p>Filenames are unicode-corrected.</p>
</dd></dl>

<dl class="method">
<dt id="EARSmilter.EARSmilter.ProcessMessage.winmail_parse">
<tt class="descname">winmail_parse</tt><big>(</big><em>fname</em><big>)</big><a class="reference internal" href="../_modules/EARSmilter/EARSmilter.html#ProcessMessage.winmail_parse"><span class="viewcode-link">[source]</span></a><a class="headerlink" href="#EARSmilter.EARSmilter.ProcessMessage.winmail_parse" title="Permalink to this definition">¶</a></dt>
<dd><p>If a WINMAIL.DAT file is attached to this message, parse and attempt to extract the files it contains.</p>
<p>For more information on WINMAIL.DAT and TNEF files, please see <a class="reference external" href="http://en.wikipedia.org/wiki/Transport_Neutral_Encapsulation_Format">Transport Neutral Encapsulation Format</a></p>
</dd></dl>

<dl class="method">
<dt id="EARSmilter.EARSmilter.ProcessMessage.delete_attachments">
<tt class="descname">delete_attachments</tt><big>(</big><em>part</em>, <em>notice</em><big>)</big><a class="reference internal" href="../_modules/EARSmilter/EARSmilter.html#ProcessMessage.delete_attachments"><span class="viewcode-link">[source]</span></a><a class="headerlink" href="#EARSmilter.EARSmilter.ProcessMessage.delete_attachments" title="Permalink to this definition">¶</a></dt>
<dd><p>For each attachment that needs to be removed from the message,
edit the headers of the message and add in the &#8220;Retrieve_Attachments.html&#8221; file.</p>
<p>This only needs to be run once to avoid multiple copies of the HTML file being attached</p>
</dd></dl>

<dl class="method">
<dt id="EARSmilter.EARSmilter.ProcessMessage.mako_notice">
<tt class="descname">mako_notice</tt><big>(</big><em>fnames</em><big>)</big><a class="reference internal" href="../_modules/EARSmilter/EARSmilter.html#ProcessMessage.mako_notice"><span class="viewcode-link">[source]</span></a><a class="headerlink" href="#EARSmilter.EARSmilter.ProcessMessage.mako_notice" title="Permalink to this definition">¶</a></dt>
<dd><p>The &#8220;Retrieve_Attachments.html&#8221; file is generated.using the <a class="reference external" href="http://www.makotemplates.org/">Mako Template Engine for Python</a>.</p>
<p>The template is stored in the <em>www</em> subfolder of the main EARS milter folder.  The CSS and image files should be stored on
an externally-accessible web server.</p>
<p>Each filename is encoded in Unicode and parsed to be valid for URLs (hence, special characters like ampersands and percent signs
can be part of valid filenames and still downloaded properly).</p>
</dd></dl>

</dd></dl>

</div>
<div class="section" id="filesys">
<span id="id4"></span><h2>FileSys<a class="headerlink" href="#filesys" title="Permalink to this headline">¶</a></h2>
<dl class="class">
<dt id="EARSmilter.EARSmilter.FileSys">
<em class="property">class </em><tt class="descclassname">EARSmilter.EARSmilter.</tt><tt class="descname">FileSys</tt><big>(</big><em>msg</em><big>)</big><a class="reference internal" href="../_modules/EARSmilter/EARSmilter.html#FileSys"><span class="viewcode-link">[source]</span></a><a class="headerlink" href="#EARSmilter.EARSmilter.FileSys" title="Permalink to this definition">¶</a></dt>
<dd><dl class="method">
<dt id="EARSmilter.EARSmilter.FileSys.__init__">
<tt class="descname">__init__</tt><big>(</big><em>msg</em><big>)</big><a class="reference internal" href="../_modules/EARSmilter/EARSmilter.html#FileSys.__init__"><span class="viewcode-link">[source]</span></a><a class="headerlink" href="#EARSmilter.EARSmilter.FileSys.__init__" title="Permalink to this definition">¶</a></dt>
<dd><p><strong>msg</strong> - Message passed directly from the Milter</p>
<p>Variables that are established for this class are:</p>
<ul class="simple">
<li><strong>dropDir</strong> - Base folder where attachment files will be stored</li>
<li><strong>min_attach_size</strong> - Minimum attachment size to detach from the message</li>
<li><strong>remfile</strong> - Name of the file with links to removed attachments</li>
</ul>
</dd></dl>

<dl class="method">
<dt id="EARSmilter.EARSmilter.FileSys.Dir">
<tt class="descname">Dir</tt><big>(</big><big>)</big><a class="reference internal" href="../_modules/EARSmilter/EARSmilter.html#FileSys.Dir"><span class="viewcode-link">[source]</span></a><a class="headerlink" href="#EARSmilter.EARSmilter.FileSys.Dir" title="Permalink to this definition">¶</a></dt>
<dd><p>Creates a unique folder in the <strong>dropDir</strong> based on the hash of the whole incoming message</p>
</dd></dl>

<dl class="method">
<dt id="EARSmilter.EARSmilter.FileSys.hashit">
<tt class="descname">hashit</tt><big>(</big><em>data</em><big>)</big><a class="reference internal" href="../_modules/EARSmilter/EARSmilter.html#FileSys.hashit"><span class="viewcode-link">[source]</span></a><a class="headerlink" href="#EARSmilter.EARSmilter.FileSys.hashit" title="Permalink to this definition">¶</a></dt>
<dd><p>Generates a hash for <strong>dropDir</strong> folders and individual files</p>
</dd></dl>

<dl class="method">
<dt id="EARSmilter.EARSmilter.FileSys.filesize_notation">
<tt class="descname">filesize_notation</tt><big>(</big><em>filesize</em><big>)</big><a class="reference internal" href="../_modules/EARSmilter/EARSmilter.html#FileSys.filesize_notation"><span class="viewcode-link">[source]</span></a><a class="headerlink" href="#EARSmilter.EARSmilter.FileSys.filesize_notation" title="Permalink to this definition">¶</a></dt>
<dd><p>Determines proper filesize notation (K, M, G) based on mathematical calculation loop</p>
</dd></dl>

<dl class="method">
<dt id="EARSmilter.EARSmilter.FileSys.unicodeConvert">
<tt class="descname">unicodeConvert</tt><big>(</big><em>fname</em><big>)</big><a class="reference internal" href="../_modules/EARSmilter/EARSmilter.html#FileSys.unicodeConvert"><span class="viewcode-link">[source]</span></a><a class="headerlink" href="#EARSmilter.EARSmilter.FileSys.unicodeConvert" title="Permalink to this definition">¶</a></dt>
<dd><p>Convert text to unicode.</p>
<p>This was designed to address issues with Latin-1 (iso-8859-1) encoding
in addition to other foreign characters.</p>
</dd></dl>

</dd></dl>

</div>
</div>


          </div>
        </div>
      </div>
      <div class="sphinxsidebar">
        <div class="sphinxsidebarwrapper">
  <h3><a href="../index.html">Table Of Contents</a></h3>
  <ul>
<li><a class="reference internal" href="#">EARS Milter main class/functions</a><ul>
<li><a class="reference internal" href="#earslog">EARSlog</a></li>
<li><a class="reference internal" href="#milter">milter</a></li>
<li><a class="reference internal" href="#processmessage">ProcessMessage</a></li>
<li><a class="reference internal" href="#filesys">FileSys</a></li>
</ul>
</li>
</ul>

  <h4>Previous topic</h4>
  <p class="topless"><a href="EARS_py.html"
                        title="previous chapter">EARS.py</a></p>
  <h4>Next topic</h4>
  <p class="topless"><a href="purgeEARSdb_py.html"
                        title="next chapter">purgeEARSdb.py</a></p>
  <h3>This Page</h3>
  <ul class="this-page-menu">
    <li><a href="../_sources/codedocs/EARSmilter.txt"
           rel="nofollow">Show Source</a></li>
  </ul>
<div id="searchbox" style="display: none">
  <h3>Quick search</h3>
    <form class="search" action="../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    <p class="searchtip" style="font-size: 90%">
    Enter search terms or a module, class or function name.
    </p>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="right" >
          <a href="purgeEARSdb_py.html" title="purgeEARSdb.py"
             >next</a> |</li>
        <li class="right" >
          <a href="EARS_py.html" title="EARS.py"
             >previous</a> |</li>
        <li><a href="../index.html">EARSmilter 1.0 documentation</a> &raquo;</li>
          <li><a href="../codedocs.html" >EARS Code</a> &raquo;</li> 
      </ul>
    </div>
    <div class="footer">
        &copy; Copyright 2012, Larry G. Wapnitsky.
      Last updated on Aug 28, 2012.
      Created using <a href="http://sphinx.pocoo.org/">Sphinx</a> 1.1.3.
    </div>
  </body>
</html>